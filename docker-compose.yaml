version: "3.9"

# =============================================================================
# DRONE CONVOY TRACKING SYSTEM - Complete Stack
# =============================================================================
#
# Place this file at project root: react-d3-drone-convoy-tracker/
#
# Usage:
#   docker compose up -d                              # Core stack (frontend + backend + infra)
#   docker compose up -d frontend                     # Frontend only
#   docker compose --profile monitoring up -d         # Core + monitoring
#   docker compose --profile dev up -d frontend-dev   # Frontend hot-reload dev
#   docker compose logs -f                            # Follow logs
#   docker compose down                               # Stop all
#   docker compose down -v                            # Stop and remove volumes
#
# Services:
#   - Frontend:    http://localhost:8080 (production) or :5173 (dev)
#   - API:         http://localhost:3000
#   - WebSocket:   ws://localhost:9090
#   - Grafana:     http://localhost:3001 (admin/admin) [monitoring profile]
#   - Prometheus:  http://localhost:9091 [monitoring profile]
#   - Jaeger:      http://localhost:16686 [monitoring profile]
#   - ScyllaDB:    localhost:9042
#   - Redis:       localhost:6379
# =============================================================================

services:
  # ============================================================================
  # FRONTEND - React + Vite + D3.js + Google Maps (Production)
  # ============================================================================
  frontend:
    build:
      context: ./drone-convoy-sortie
      dockerfile: Dockerfile
    container_name: drone-frontend
    ports:
      - "8080:80"
    environment:
      - VITE_API_URL=http://localhost:3000
      - VITE_WS_URL=ws://localhost:9090
    networks:
      - drone-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # FRONTEND DEV - Hot reload for development
  # ============================================================================
  frontend-dev:
    image: node:20-alpine
    container_name: drone-frontend-dev
    working_dir: /app
    ports:
      - "5173:5173"
    volumes:
      - ./drone-convoy-sortie:/app
      - frontend_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    environment:
      - VITE_API_URL=http://localhost:3000
      - VITE_WS_URL=ws://localhost:9090
    networks:
      - drone-network
    profiles:
      - dev
    stdin_open: true
    tty: true

  # ============================================================================
  # BACKEND - Rust API Server
  # ============================================================================
  drone-api:
    build:
      context: ./drone-convoy-tracking-server
      dockerfile: Dockerfile
      target: runtime
    container_name: drone-api
    ports:
      - "3000:3000"
      - "9090:9090"
    environment:
      - RUST_LOG=info,drone_api=debug,drone_websocket=debug
      - SCYLLA_HOSTS=scylla-node1:9042,scylla-node2:9042,scylla-node3:9042
      - SCYLLA_KEYSPACE=drone_convoy
      - REDIS_URL=redis://redis:6379
      - API_PORT=3000
      - WS_PORT=9090
    depends_on:
      scylla-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    networks:
      - drone-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  # ============================================================================
  # SCYLLADB CLUSTER - 3 Node Configuration
  # ============================================================================
  scylla-node1:
    image: scylladb/scylla:5.4
    container_name: scylla-node1
    command: >
      --seeds=scylla-node1
      --smp 2
      --memory 1G
      --overprovisioned 1
      --api-address 0.0.0.0
      --developer-mode 1
    ports:
      - "9042:9042"
      - "9180:9180"
    volumes:
      - scylla-data1:/var/lib/scylla
    networks:
      - drone-network
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    restart: unless-stopped

  scylla-node2:
    image: scylladb/scylla:5.4
    container_name: scylla-node2
    command: >
      --seeds=scylla-node1
      --smp 2
      --memory 1G
      --overprovisioned 1
      --api-address 0.0.0.0
      --developer-mode 1
    volumes:
      - scylla-data2:/var/lib/scylla
    networks:
      - drone-network
    depends_on:
      scylla-node1:
        condition: service_healthy
    restart: unless-stopped

  scylla-node3:
    image: scylladb/scylla:5.4
    container_name: scylla-node3
    command: >
      --seeds=scylla-node1
      --smp 2
      --memory 1G
      --overprovisioned 1
      --api-address 0.0.0.0
      --developer-mode 1
    volumes:
      - scylla-data3:/var/lib/scylla
    networks:
      - drone-network
    depends_on:
      scylla-node2:
        condition: service_started
    restart: unless-stopped

  # ============================================================================
  # SCYLLA SCHEMA INITIALIZER - Auto-loads schema.cql
  # ============================================================================
  scylla-init:
    image: scylladb/scylla:5.4
    container_name: scylla-init
    depends_on:
      scylla-node1:
        condition: service_healthy
    volumes:
      - ./drone-convoy-tracking-server/schema.cql:/schema.cql:ro
    entrypoint: []
    command: >
      bash -c "
        set -e
        echo 'Waiting for ScyllaDB cluster to stabilize...'
        sleep 10
        
        echo 'Checking cluster status...'
        until cqlsh scylla-node1 -e 'describe cluster' 2>/dev/null; do
          echo '   Cluster not ready, retrying in 5s...'
          sleep 5
        done
        
        echo 'Cluster is ready!'
        echo 'Loading schema from schema.cql...'
        
        if cqlsh scylla-node1 -f /schema.cql; then
          echo 'Schema loaded successfully!'
        else
          echo 'Schema may already exist or partial load - continuing...'
        fi
        
        echo 'Verifying keyspace exists...'
        cqlsh scylla-node1 -e 'describe keyspace drone_convoy' && echo 'Keyspace verified!' || echo '⚠️  Keyspace check failed'
        
        echo 'ScyllaDB initialization complete!'
      "
    networks:
      - drone-network
    restart: "no"

  # ============================================================================
  # REDIS - Caching and Pub/Sub
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: drone-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru
    networks:
      - drone-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ============================================================================
  # OBSERVABILITY STACK (--profile monitoring)
  # ============================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: drone-prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./drone-convoy-tracking-server/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=7d'
    networks:
      - drone-network
    profiles:
      - monitoring
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.0
    container_name: drone-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./drone-convoy-tracking-server/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./drone-convoy-tracking-server/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - drone-network
    profiles:
      - monitoring
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: drone-jaeger
    ports:
      - "16686:16686"
      - "6831:6831/udp"
      - "14268:14268"
      - "4317:4317"
      - "4318:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - drone-network
    profiles:
      - monitoring
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  drone-network:
    driver: bridge
    name: drone-convoy-net
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  scylla-data1:
    name: drone-scylla-data1
  scylla-data2:
    name: drone-scylla-data2
  scylla-data3:
    name: drone-scylla-data3
  redis-data:
    name: drone-redis-data
  prometheus-data:
    name: drone-prometheus-data
  grafana-data:
    name: drone-grafana-data
  frontend_node_modules:
    name: drone-frontend-node-modules